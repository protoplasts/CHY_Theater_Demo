@{
    ViewData["Title"] = "會員中心";
    Layout = "_MemberCenterLayout";
}


<div class="col-md-9 mt-5">
    <h2 class="mb-4">會員中心</h2>

    @if (User.Identity.IsAuthenticated)
    {
        var twofactor = ViewData["TwoFactorEnabled"];
        var isTwoFactorClientRemembered = ViewData["IsTwoFactorClientRemembered"];
        if (twofactor != null && twofactor.ToString().ToLower() == "true")
        {
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">雙重驗證已啟用</h5>
                    <p class="card-text">您的帳戶目前已啟用雙重驗證保護。</p>
                    <a href="#" id="removeAuthenticator" class="btn btn-warning">重設並移除雙重驗證</a>
                    @if (isTwoFactorClientRemembered.ToString().ToLower() == "true")
                    {
                       <form asp-action="RemoveRememberClient" asp-controller="Authenticator" method="post" class="d-inline">
						<button type="submit" class="btn btn-danger ml-2">移除記住的裝置</button>
					    </form> 
                    }                            
                </div>
            </div>
        }
        else
        {
            <div class="card mb-4" id="setupTwoFactorCard">
                <div class="card-body" >
                    <h5 class="card-title">設置雙重驗證</h5>
                    <p class="card-text">增強您帳戶的安全性，啟用雙重驗證。</p>
                    <a href="#" id="setupTwoFactor" class="btn btn-primary">設置雙重驗證</a>
				</div>

			</div>

			<div id="twoFactorContent" class="mb-4"></div>
        }
    }

   </div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            $("#setupTwoFactor").click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: '@Url.Action("EnableAuthenticator", "Authenticator")',
                    type: 'GET',
                    success: function (result) {
                        $("#twoFactorContent").html(result);
                            $("#setupTwoFactorCard").hide(); // Hide the setup card
                            $("#enableAuthenticator").submit(function (e) {
                            e.preventDefault();
                            $.ajax({
                                url: '@Url.Action("EnableAuthenticator", "Authenticator")',
                                type: 'POST',
                                data: $(this).serialize(),
                                success: function (result) {
                                    if (result.success) {
                                        Swal.fire({
                                            title: '成功！',
                                            text: '雙重驗證已成功啟用。',
                                            icon: 'success',
                                            confirmButtonText: '確定'
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                window.location.href = 'https://localhost:7002/Identity/MemberCenter';
                                            }
                                        });
                                    } else {
                                        $("#twoFactorContent").html(result);
                                    }
                                },
                                error: function (error) {
                                    console.log(error);
                                    Swal.fire({
                                        title: '錯誤！',
                                        text: '啟用雙重驗證時發生錯誤。',
                                        icon: 'error',
                                        confirmButtonText: '確定'
                                    });
                                }
                            });
                        });
                    },
                    error: function (error) {
                        console.log(error);
                        Swal.fire({
                            title: '錯誤！',
                            text: '載入驗證器設置時發生錯誤。',
                            icon: 'error',
                            confirmButtonText: '確定'
                        });
                    }
                });
            });

            $("#removeAuthenticator").click(function (e) {
                e.preventDefault();
                Swal.fire({
                    title: '您確定嗎？',
                    text: "您即將移除雙重驗證。此操作無法撤銷。",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '是的，移除它！',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("RemoveAuthenticator", "Authenticator")';
                    }
                });
            });
        });
    </script>
}