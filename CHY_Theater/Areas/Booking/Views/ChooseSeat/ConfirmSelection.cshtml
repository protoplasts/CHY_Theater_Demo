@using FUEN104_2_FinalProject.Models.ViewModels
@model ConfirmSelectionViewModel
@Html.AntiForgeryToken()


@section Styles {
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .seat-selection-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .movie-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            align-items: start;
            margin-top: 20px;
        }

        .movie-poster img {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
        }

        .animateBtn {
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        main[role="main"] {
            flex: 1 0 auto;
            padding-bottom: 100px;
        }

        footer {
            flex-shrink: 0;
        }
    </style>
}
@functions {
    string GetLevelImagePath(string level)
    {
        if (int.TryParse(level, out int levelInt))
        {
            if (levelInt >= 1 && levelInt <= 5)
            {
                return $"/img/Class/index_icon_0{levelInt}.jpg";
            }
        }
        return "~/img/Class/index_icon_default.png";
    }
}
<div class="seat-selection-container my-3">
    <div class="movie-details">
        <div class="movie-poster">
            <img src="@Model.MovieImg" alt="Movie Poster">
        </div>
        <div class="movie-info">
            <h3>@Model.MovieName (@Model.MovieEnglishName)</h3>
            <p><strong>級別:</strong></p>

            <img src="@GetLevelImagePath(Model.Level)" alt="Level @Model.Level" class="" style="height:50px" />

            <p><strong>開演時間:</strong> @Model.ShowDateTime.ToString("yyyy/MM/dd HH:mm")</p>
            <p><strong>地點:</strong> @Model.AuditoriumName</p>
            <p><strong>地點:</strong> @Model.MerchantTradeNo</p>
            <p><strong>票種:</strong></p>
            <ul>
                @foreach (var ticketType in Model.SelectedTickets)
                {
                    <p>@ticketType.TypeName - @ticketType.Quantity 張 </p>

                }
            </ul>
            <p><strong>明細:</strong></p>
            <ul>
                @foreach (var ticket in Model.SelectedTickets)
                {
                    <ul>
                        @foreach (var item in ticket.ParsedTicketDescription)
                        {
                            <li>@item.Description x @(item.Quantity * ticket.Quantity)</li>
                        }
                    </ul>
                }
            </ul>
            <p><strong>加購品項: </strong></p>
            <ul>


                @foreach (var ticketType in Model.SelectedSnacks)
                {
                    <li>

                        @ticketType.SnackName x @ticketType.Quantity

                    </li>
                }
            </ul>
            <p><strong>座位:</strong></p>
            <ul>
                @foreach (var seat in Model.SelectedSeats)
                {
                    <li>@seat.SeatRow 排 @seat.SeatNumber 號</li>
                }
            </ul>
            <p><strong>總計:</strong> <span id="totalPrice">@Model.MovieTotalPrice</span></p>

            <div class="coupon-section mt-3">
                <div class="input-group">
                    <input type="text" id="couponCode" class="form-control" placeholder="輸入優惠碼">
                    <div class="input-group-append">
                        <button id="applyCouponBtn" class="btn btn-outline-secondary" type="button" onclick="applyCoupon()">應用優惠碼</button>
                        <button id="cancelCouponBtn" class="btn btn-outline-danger" type="button" onclick="cancelCoupon()" style="display: none;">取消使用</button>
                    </div>
                </div>
                <small id="couponMessage" class="form-text text-muted"></small>
            </div>

            <button class="btn btn-primary btn-block animateBtn mt-4" onclick="proceedToPayment()">確認訂單</button>
        </div>
    </div>
    <div id="paymentOptions" style="display: none;">
        <h4>選擇付款方式</h4>
        <button class="btn btn-primary m-2" onclick="useECPay()">使用綠界支付付款</button>
        <button class="btn btn-secondary m-2" onclick="payLater()">現場取票付款</button>
    </div>
    <div id="ECPayContent"></div>
</div>



<!-- New payment options section -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        var currentTotalPrice = parseFloat('@Model.MovieTotalPrice'.replace(/[^0-9.-]+/g, ""));
        var originalTotalPrice = currentTotalPrice;
        var appliedCouponCode = '';

        function applyCoupon() {
            var couponCode = $('#couponCode').val();

            $.ajax({
                url: '/Booking/ValidateCoupon',
                type: 'POST',
                data: JSON.stringify({
                    couponCode: couponCode,
                    currentTotal: currentTotalPrice
                }),
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.isValid) {
                        currentTotalPrice = response.newTotal;
                        appliedCouponCode = couponCode;
                        $('#totalPrice').text(response.newTotalFormatted);
                        $('#couponMessage').text('優惠碼已成功應用！').removeClass('text-danger').addClass('text-success');

                        // Disable the coupon input and apply button, show cancel button
                        $('#couponCode, #applyCouponBtn').prop('disabled', true);
                        $('#cancelCouponBtn').show();
                        $('#applyCouponBtn').hide();
                    } else {
                        $('#couponMessage').text(response.message).removeClass('text-success').addClass('text-danger');
                    }
                },
                error: function () {
                    $('#couponMessage').text('驗證優惠碼時發生錯誤。請重試。').removeClass('text-success').addClass('text-danger');
                }
            });
        }

        function cancelCoupon() {
            // Reset to original price
            currentTotalPrice = originalTotalPrice;
            $('#totalPrice').text(originalTotalPrice.toFixed(2));

            // Clear coupon code and message
            $('#couponCode').val('').prop('disabled', false);
            $('#couponMessage').text('').removeClass('text-success text-danger');

            // Reset button states
            $('#applyCouponBtn').prop('disabled', false).show();
            $('#cancelCouponBtn').hide();

            appliedCouponCode = '';
        }

        function proceedToPayment() {
            // Implement your payment logic here
            Swal.fire({
                title: '進行支付',
                text: '正在進行支付...',
                icon: 'info',
                showConfirmButton: false,
                timer: 2000
            });

            var bookingData = {
                MerchantTradeNo: "@Model.MerchantTradeNo",
                Auditoriumid: @Model.Auditoriumid,
                Showid: @Model.Showid,
                MovieName: '@Model.MovieName',
                MovieEnglishName: '@Model.MovieEnglishName',
                Level: '@Model.Level',
                ShowDateTime: '@Model.ShowDateTime.ToString("yyyy-MM-ddTHH:mm:ss")',
                AuditoriumName: '@Model.AuditoriumName',
                SelectedSeats: @Html.Raw(Json.Serialize(Model.SelectedSeats)),
                SelectedSnacks: @Html.Raw(Json.Serialize(Model.SelectedSnacks)),
                SelectedTickets: @Html.Raw(Json.Serialize(Model.SelectedTickets)),
                CouponCode: appliedCouponCode,
                MovieTotalPrice: Math.round(currentTotalPrice), // or parseInt(currentTotalPrice)


            };

            // Send an AJAX request to save the booking
            $.ajax({
                url: '/Booking/Booking/ProcessPayment', // Adjust this to include the area
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: JSON.stringify(bookingData),
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            title: '成功',
                            text: '訂票成功。請選擇支付方式。',
                            icon: 'success',
                            showConfirmButton: true
                        }).then(() => {
                            // Show payment options instead of redirecting
                            $('#paymentOptions').show();
                            // Hide the original button and coupon section
                            $('.animateBtn').hide();
                            $('.coupon-section').hide();
                        });
                    } else {
                        Swal.fire({
                            title: '失敗',
                            text: '訂票失敗。請重試。',
                            icon: 'error',
                            showConfirmButton: true
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        title: '錯誤',
                        text: '發生錯誤。請重試。',
                        icon: 'error',
                        showConfirmButton: true
                    });
                }
            });

        }

        function useECPay() {
            Swal.fire({
                title: 'EC Pay',
                text: '準備 EC Pay 支付...',
                icon: 'info',
                showConfirmButton: false,
                timer: 1000
            }).then(() => {
                var totalAmount = Math.round(currentTotalPrice);
                var merchantTradeNo = '@Model.MerchantTradeNo';
                // Hide the payLater button
                $('#payLaterBtn').hide();
                // Instead of redirecting, load the EC Pay form
                loadECPayForm(totalAmount, merchantTradeNo);
            });
        }

        function loadECPayForm(totalAmount, merchantTradeNo) {
            $.ajax({
                url: '/ECP/GetPaymentForm',
                type: 'GET',
                data: { totalAmount: totalAmount, merchantTradeNo: merchantTradeNo },
                success: function (response) {
                    $('#ECPayContent').html(response);
                    $('#ECPayContent').show();
                },
                error: function () {
                    Swal.fire({
                        title: '錯誤',
                        text: '無法載入支付表單。請重試。',
                        icon: 'error',
                        showConfirmButton: true
                    });
                }
            });
        }
        function abandonOnlinePayment() {
            Swal.fire({
                title: '確認放棄線上支付',
                text: '確定放棄線上支付改為現場取票付款嗎?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，放棄線上支付',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hide EC Pay form
                    $('#ECPayContent').hide();

                    // Show payLater button again
                    $('#payLaterBtn').show();

                    // Call payLater function
                    payLater();
                }
            });
        }
        function payLater() {
            Swal.fire({
                title: '訂單已保存',
                text: '請記得在開演前15分鐘完成取票付款。',
                icon: 'info',
                showConfirmButton: true
            }).then(() => {
                // You might want to redirect to a confirmation page or update the UI
            });
        }
    </script>
}
