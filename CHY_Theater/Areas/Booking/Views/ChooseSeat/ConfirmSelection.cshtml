@using FUEN104_2_FinalProject.Models.ViewModels
@using System.Web
@model ConfirmSelectionViewModel
@Html.AntiForgeryToken()


@section Styles {
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .bg-img{
            background-image: url('/img/test3.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: repeat;
            position: relative;
        }
        .seat-selection-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            margin-top: 85px !important;
            
        }

        .movie-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: start;
            margin-bottom: 2rem;
            background-color: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .movie-poster img {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .movie-info h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }

        .movie-info p {
            margin-bottom: 0.7rem;
            font-size: 1rem;
            color: #555;
        }

        .movie-info strong {
            color: #333;
            font-weight: 600;
        }

        .movie-info ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 1rem;
        }

        .movie-info li {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: ivory;
            border-radius: 4px;
            width:80%;
        }
        .animateBtn {
            animation: pulse 2s infinite;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            margin-top: 1.5rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }
        @@keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        main[role="main"] {
            flex: 1 0 auto;
            padding-bottom: 100px;
        }

        footer {
            flex-shrink: 0;
        }

        .reward-points-section {
            background-color: papayawhip;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

            .reward-points-section p {
                margin-bottom: 10px;
                font-size: 14px;
            }

            .reward-points-section span {
                font-weight: bold;
                color: #007bff;
            }

            .reward-points-section button {
                margin-top: 10px;
                padding: 8px 15px;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            
        .reward-points-section button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }

        #usePointsBtn {
            background-color: #28a745;
            color: white;
            border: none;
        }

        #cancelPointsBtn {
            background-color: #dc3545;
            color: white;
            border: none;
        }

        #applyCouponBtn{
            background-color:red;
            color: white;
        }

            #applyCouponBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

            .button-row .btn {
                flex: 1;
                margin: 0 0.5rem;
                width: auto;
                min-width: 120px;
                max-width: 180px;
            }

        .btn-abandon {
            background-color: red;
            color: white;
            width:50%
        }
       
      
        #paymentOptions {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

            #paymentOptions h4 {
                margin-bottom: 1rem;
                color: #333;
            }

            #paymentOptions button {
                transition: all 0.3s ease;
            }

                #paymentOptions button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }
                  @@media (max-width: 768px) {
            .movie-details {
                grid-template-columns: 1fr;
            }

            .movie-poster {
                text-align: center;
                margin-bottom: 1rem;
            }

            .movie-poster img {
                max-width: 200px;
            }
        }
    </style>
}
@functions {
    string GetLevelImagePath(string level)
    {
        if (int.TryParse(level, out int levelInt))
        {
            if (levelInt >= 1 && levelInt <= 5)
            {
                return $"/img/Class/index_icon_0{levelInt}.jpg";
            }
        }
        return "~/img/Class/index_icon_default.png";
    }
}
<section class="bg-img">
<div class="seat-selection-container my-3">
    <div class="movie-details">
        <div class="movie-poster">
            <img src="@Html.Raw(HttpUtility.HtmlDecode(Model.MovieImg))" alt="Movie Poster">
        </div>
        <div class="movie-info">
            <h3>@Model.MovieName (@Model.MovieEnglishName)</h3>
            <p>
                <strong>
                    級別:<img src="@GetLevelImagePath(Model.Level)" alt="Level @Model.Level" class="" style="height:50px" />
                </strong>
            </p>


            <p><strong>開演時間:</strong> @Model.ShowDateTime.ToString("yyyy/MM/dd HH:mm")</p>
            <p><strong>地點:</strong> @Model.AuditoriumName</p>
            <p style="display:none">strong>訂票編號:</strong> @Model.MerchantTradeNo</p>
            <p><strong>票種:</strong></p>
            <ul>
                @foreach (var ticketType in Model.SelectedTickets)
                {
                    <li>@ticketType.TypeName - @ticketType.Quantity 張 </li>
                }
            </ul>
            <p><strong>明細:</strong></p>
            <ul>
                @foreach (var ticket in Model.SelectedTickets)
                {
                    <ul>
                        @foreach (var item in ticket.ParsedTicketDescription)
                        {
                            <li>@item.Description x @(item.Quantity * ticket.Quantity)</li>
                        }
                    </ul>
                }
            </ul>
            <p><strong>加購品項: </strong></p>
            <ul>
                @foreach (var ticketType in Model.SelectedSnacks)
                {
                    <li>@ticketType.SnackName x @ticketType.Quantity</li>
                }
            </ul>
            <p><strong>座位:</strong></p>
            <ul>
                @foreach (var seat in Model.SelectedSeats)
                {
                    <li>@seat.SeatRow 排 @seat.SeatNumber 號</li>
                }
            </ul>
            <p><strong>總計:</strong> <span id="totalPrice">@Model.MovieTotalPrice</span></p>

                <div class="coupon-section mt-3">
                    <div class="form-group">
                        <label for="userCouponSelect">選擇優惠券</label>
                        <select id="userCouponSelect" class="form-control">
                            <option value="選擇優惠券">選擇優惠券</option>
                            @foreach (var userCoupon in ViewBag.UserCoupons)
                            {
                                <option value="@userCoupon.Coupon.CouponCode" data-discount-type="@userCoupon.Coupon.DiscountType" data-discount-value="@userCoupon.Coupon.DiscountValue">
                                    @userCoupon.Coupon.Description (@userCoupon.Coupon.DiscountType: @userCoupon.Coupon.DiscountValue)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="form-group mt-2" id="couponCodeInputSection">
                        <label for="couponCode">輸入優惠碼</label>
                        <input type="text" id="couponCode" class="form-control" placeholder="輸入優惠碼">
                    </div>

                    <div class="input-group mt-2" id="CouponBtnSection">
                        <div class="input-group-append">
                            <button id="applyCouponBtn" class="btn btn-outline-secondary" type="button" onclick="applyCoupon()">應用優惠碼</button>
                            <button id="cancelCouponBtn" class="btn btn-outline-danger" type="button" onclick="cancelCoupon()" style="display: none;">取消使用</button>
                        </div>
                    </div>

                    <small id="couponMessage" class="form-text text-dark mt-2"></small>
                </div>

            <div class="reward-points-section mt-3">
                <p>您有 <span id="availablePoints">@ViewBag.AvailablePoints</span> 點可用獎勵點數。</p>
                <p>已使用點數: <span id="appliedPoints">0</span></p>
                <p>點數折抵金額: $<span id="pointsDiscount">0</span></p>
                <button id="usePointsBtn" class="btn">使用紅利折抵</button>
                <button id="cancelPointsBtn" class="btn" style="display: none;">取消使用</button>
            </div>
                <div class="button-row">
                    <button class="btn btn-abandon animateBtn" onclick="goBackToIndex()">放棄本次訂票</button>
                    <button class="btn btn-primary animateBtn" onclick="proceedToPayment()">確認訂單</button>
                </div>
        </div>
    </div>
    <div id="paymentOptions" style="display: none;">
        <h4>選擇付款方式</h4>
        <button class="btn btn-primary m-2" onclick="useECPay()">使用綠界支付付款</button>
        <button class="btn btn-secondary m-2" onclick="payLater()">現場取票付款</button>
    </div>
    <div id="ECPayContent"></div>
	</div>
</section>



<!-- New payment options section -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function goBackToIndex() {
            Swal.fire({
                title: '警告',
                html: '<div class="custom-swal-text">要離開此頁面嗎？<br>您的先前的選擇將會遺失!</div>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '離開',
                cancelButtonText: '留下'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Remove any onbeforeunload handler before navigating
                    window.onbeforeunload = null;
                    // Navigate to the index page
                    window.location.href = '/Booking/ChooseTheaterAuditorium';
                }
            });
        }

        var currentTotalPrice;

        $(document).ready(function () {
            let originalTotal = parseFloat('@Model.MovieTotalPrice'.replace(/[^0-9.-]+/g, ""));
            currentTotalPrice = originalTotal; 
            let appliedCouponDiscount = 0;
            let appliedPointsDiscount = 0;
            let appliedPoints = 0;
            let appliedCouponCode = '';
            $('#userCouponSelect').change(function () {
                var selectedCoupon = $(this).val();
                if (selectedCoupon == "選擇優惠券") 
                {
                    cancelCoupon();
                    $('#couponCode').show();
                    $('#CouponBtnSection').show();
                    $('#couponCodeInputSection').show();
                }
                else
                {
                    $('#couponCode').val(selectedCoupon);
                    $('#CouponBtnSection').hide();
                    $('#couponCodeInputSection').hide();
                    applyCoupon();
                }
            });

            function updateTotalPrice() {
                currentTotalPrice = originalTotal - appliedCouponDiscount - appliedPointsDiscount;
                $('#totalPrice').text(currentTotalPrice.toFixed(0));
            }

            function applyCoupon() {
                var couponCode = $('#couponCode').val();
                $.ajax({
                    url: '/Booking/ChooseSeat/ValidateCoupon',
                    type: 'POST',
                    data: JSON.stringify({
                        couponCode: couponCode,
                        currentTotal: currentTotalPrice
                    }),
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.isValid) {
                            appliedCouponDiscount = currentTotalPrice - response.newTotal;
                            updateTotalPrice();
                            appliedCouponCode = couponCode;
                            $('#couponMessage').text('優惠碼已成功應用！').removeClass('text-dark').addClass('text-danger');

                            // Disable the coupon input and apply button, show cancel button
                            $('#couponCode, #applyCouponBtn').prop('disabled', true);
                            $('#cancelCouponBtn').show();
                            $('#applyCouponBtn').hide();
                        } else {
                            $('#couponMessage').text(response.message).removeClass('text-dark').addClass('text-danger');
                        }
                    },
                    error: function () {
                        $('#couponMessage').text('驗證優惠碼時發生錯誤。請重試。').removeClass('text-dark').addClass('text-danger');
                    }
                });
            }

            function cancelCoupon() {
                appliedCouponDiscount = 0;
                updateTotalPrice();

                // Clear coupon code and message
                $('#couponCode').val('').prop('disabled', false);
                $('#couponMessage').text('').removeClass('text-danger');
                $('#couponCode').show();
                // Reset button states
                $('#applyCouponBtn').prop('disabled', false).show();
                $('#cancelCouponBtn').hide();
                appliedCouponCode = '';
            }

            $('#usePointsBtn').click(function () {
                var availablePoints = parseInt($('#availablePoints').text());

                Swal.fire({
                    title: '使用紅利點數',
                    input: 'number',
                    inputAttributes: {
                        min: 0,
                        max: availablePoints,
                        step: 1
                    },
                    inputValue: appliedPoints,
                    showCancelButton: true,
                    confirmButtonText: '確認',
                    cancelButtonText: '取消',
                    showLoaderOnConfirm: true,
                    preConfirm: (pointsToUse) => {
                        pointsToUse = parseInt(pointsToUse);
                        let discount = pointsToUse; // Assuming 1 points = $1 discount
                        let newTotal = currentTotalPrice - discount;
                        return {
                            pointsToUse: pointsToUse,
                            newTotal: newTotal,
                            discount: discount
                        };
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        appliedPoints = result.value.pointsToUse;
                        appliedPointsDiscount = result.value.discount;
                        updateTotalPrice();

                        $('#appliedPoints').text(appliedPoints);
                        $('#pointsDiscount').text(appliedPointsDiscount.toFixed(0));

                        Swal.fire({
                            title: '已套用點數',
                            text: `已使用 ${appliedPoints} 點，折抵 $${appliedPointsDiscount.toFixed(0)}`,
                            icon: 'success'
                        });

                        // Show cancel button and disable use points button
                        $('#cancelPointsBtn').show();
                        $('#usePointsBtn').prop('disabled', true);
                    }
                });
            });

            $('#cancelPointsBtn').click(function () {
                appliedPoints = 0;
                appliedPointsDiscount = 0;
                updateTotalPrice();

                $('#appliedPoints').text('0');
                $('#pointsDiscount').text('0.00');

                // Hide cancel button and enable use points button
                $('#cancelPointsBtn').hide();
                $('#usePointsBtn').prop('disabled', false);

                Swal.fire({
                    title: '已取消使用點數',
                    text: '您的訂單已恢復原價',
                    icon: 'info'
                });
            });

            window.proceedToPayment = function () {
                Swal.fire({
                    title: '進行支付',
                    text: '正在進行支付...',
                    icon: 'info',
                    showConfirmButton: false,
                    timer: 2000
                });

                var bookingData = {
                    MerchantTradeNo: "@Model.MerchantTradeNo",
                    Auditoriumid: @Model.Auditoriumid,
                    Showid: @Model.Showid,
                    MovieName: '@Model.MovieName',
                    MovieEnglishName: '@Model.MovieEnglishName',
                    Level: '@Model.Level',
                    ShowDateTime: '@Model.ShowDateTime.ToString("yyyy-MM-ddTHH:mm:ss")',
                    AuditoriumName: '@Model.AuditoriumName',
                    SelectedSeats: @Html.Raw(Json.Serialize(Model.SelectedSeats)),
                    SelectedSnacks: @Html.Raw(Json.Serialize(Model.SelectedSnacks)),
                    SelectedTickets: @Html.Raw(Json.Serialize(Model.SelectedTickets)),
                    CouponCode: appliedCouponCode,
                    MovieTotalPrice: Math.round(currentTotalPrice),
                    AppliedPoints: appliedPoints,
                };

                $.ajax({
                    url: '/Booking/Booking/ProcessPayment',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: JSON.stringify(bookingData),
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                title: '成功',
                                text: '訂票成功。請選擇支付方式。',
                                icon: 'success',
                                showConfirmButton: true
                            }).then(() => {
                                $('#paymentOptions').show();
                                $('.animateBtn').hide();
                                $('.coupon-section').hide();
                                $('.reward-points-section').hide();
                            });
                        } else {
                            Swal.fire({
                                title: '失敗',
                                text: '訂票失敗。請重試。',
                                icon: 'error',
                                showConfirmButton: true
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            title: '錯誤',
                            text: '發生錯誤。請重試。',
                            icon: 'error',
                            showConfirmButton: true
                        });
                    }
                });
            };

            // Attach event handlers
            $('#applyCouponBtn').click(applyCoupon);
            $('#cancelCouponBtn').click(cancelCoupon);
        });

        function useECPay() {
            Swal.fire({
                title: 'EC Pay',
                text: '準備 EC Pay 支付...',
                icon: 'info',
                showConfirmButton: false,
                timer: 1000
            }).then(() => {
                var TotalPrice = Math.round(currentTotalPrice);
                var merchantTradeNo = '@Model.MerchantTradeNo';
                $('#payLaterBtn').hide();
                // alert(TotalPrice);
                // alert(merchantTradeNo);
                loadECPayForm(TotalPrice, merchantTradeNo);
            });
        }

        function loadECPayForm(TotalPrice, merchantTradeNo) {
            $.ajax({
                url: '/Booking/ECP/GetPaymentForm',
                type: 'GET',
                data: { TotalPrice: TotalPrice, merchantTradeNo: merchantTradeNo },
                success: function (response) {
                    $('#ECPayContent').html(response);
                    $('#ECPayContent').show();
                },
                error: function () {
                    Swal.fire({
                        title: '錯誤',
                        text: '無法載入支付表單。請重試。',
                        icon: 'error',
                        showConfirmButton: true
                    });
                }
            });
        }

        function abandonOnlinePayment() {
            Swal.fire({
                title: '確認放棄線上支付',
                text: '確定放棄線上支付改為現場取票付款嗎?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，放棄線上支付',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#ECPayContent').hide();
                    $('#payLaterBtn').show();
                    payLater();
                }
            });
        }

        function payLater() {
            Swal.fire({
                title: '訂單已保存',
                text: '請記得在開演前15分鐘完成取票付款。',
                icon: 'info',
                showConfirmButton: true
            }).then(() => {
                window.location.href = '/Customer/Home/Index';
            });
        }
    </script>
}